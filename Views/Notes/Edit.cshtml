@model NoteViewModel
@{
    ViewData["Title"] = "Edit Note";
}

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow">
                <div class="card-header bg-warning text-dark">
                    <h3 class="mb-0"><i class="fas fa-edit"></i> Edit Note</h3>
                </div>
                <div class="card-body">
                    <form asp-action="Edit" method="post" id="noteForm">
                        <input type="hidden" asp-for="Id" />
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                        
                        <div class="mb-3">
                            <label asp-for="Title" class="form-label fw-bold"></label>
                            <input asp-for="Title" class="form-control form-control-lg" placeholder="Enter note title" />
                            <span asp-validation-for="Title" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Formatting Options</label>
                            <div class="toolbar bg-light p-3 rounded">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label small">Font Family</label>
                                        <select asp-for="FontFamily" class="form-select" id="fontSelect">
                                            <option value="Arial">Arial</option>
                                            <option value="Georgia">Georgia</option>
                                            <option value="'Courier New', monospace">Courier New</option>
                                            <option value="'Times New Roman', serif">Times New Roman</option>
                                            <option value="Verdana">Verdana</option>
                                            <option value="'Comic Sans MS', cursive">Comic Sans MS</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label small">Text Color</label>
                                        <input asp-for="TextColor" type="color" class="form-control form-control-color w-100" id="colorPicker" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label small">Text Formatting</label>
                                        <div class="btn-group w-100" role="group">
                                            <button type="button" class="btn btn-outline-secondary" onclick="formatText('bold')" title="Bold">
                                                <i class="fas fa-bold"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="formatText('italic')" title="Italic">
                                                <i class="fas fa-italic"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="formatText('underline')" title="Underline">
                                                <i class="fas fa-underline"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Content" class="form-label fw-bold"></label>
                            <div id="editor" class="editor-container"></div>
                            <textarea asp-for="Content" id="contentHidden" style="display: none;"></textarea>
                            <span asp-validation-for="Content" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <div class="card">
                                <div class="card-header bg-warning">
                                    <div class="form-check">
                                        <input asp-for="IsIncognito" class="form-check-input" id="incognitoCheck" />
                                        <label asp-for="IsIncognito" class="form-check-label fw-bold">
                                            <i class="fas fa-user-secret"></i> Make this an Incognito Note
                                        </label>
                                    </div>
                                </div>
                                <div class="card-body" id="pinSection" style="display: @(Model.IsIncognito ? "block" : "none");">
                                    <label asp-for="PinCode" class="form-label">4-Digit PIN Code</label>
                                    <input asp-for="PinCode" class="form-control" maxlength="4" placeholder="Enter 4-digit PIN" />
                                    <span asp-validation-for="PinCode" class="text-danger"></span>
                                    <small class="form-text text-muted">
                                        <i class="fas fa-info-circle"></i> This PIN will be required to view this note
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-save"></i> Update Note
                            </button>
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <script>
        var quill = new Quill('#editor', {
            theme: 'snow',
            placeholder: 'Start writing your note here...',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'align': [] }],
                    ['link', 'blockquote', 'code-block'],
                    ['clean']
                ]
            }
        });

        // Load existing content
        var existingContent = document.getElementById('contentHidden').value;
        quill.root.innerHTML = existingContent;

        // Apply font and color
        function applyFormatting() {
            var font = document.getElementById('fontSelect').value;
            var color = document.getElementById('colorPicker').value;
            document.querySelector('.ql-editor').style.fontFamily = font;
            document.querySelector('.ql-editor').style.color = color;
        }

        // Apply initial formatting
        applyFormatting();

        document.getElementById('fontSelect').addEventListener('change', applyFormatting);
        document.getElementById('colorPicker').addEventListener('input', applyFormatting);

        // Sync content before submit
        document.getElementById('noteForm').addEventListener('submit', function() {
            document.getElementById('contentHidden').value = quill.root.innerHTML;
        });

        // Toggle PIN section
        document.getElementById('incognitoCheck').addEventListener('change', function() {
            document.getElementById('pinSection').style.display = this.checked ? 'block' : 'none';
        });

        function formatText(command) {
            quill.format(command, !quill.getFormat()[command]);
        }
    </script>
}
